{% extends 'portaladmin/base.html' %}
{% load i18n %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% block topcontent %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="page-header">Calendar </h2>
    </div>
    <!-- /.col-lg-12 -->
</div>
{% endblock topcontent %}
{% block botcontent %}
<div class="col-lg-12">
    <div class="panel panel-default">
        <div class="panel-heading">
             Calendar
        </div>
        <!-- /.panel-heading -->
        <div id='calendar'></div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
</div>
<!-- /.col-lg-12 -->
{% endblock botcontent%}

{% block morescript %}
<style>
.modal.bootstrap-dialog.size-normal.type-primary.fade.in {
    z-index: 1 !important;
}
</style>
<script src="{%static "bower_components/moment/min/moment.min.js" %}"></script>
<script src="{%static "bower_components/fullcalendar/dist/fullcalendar.js" %}"></script>
<script src="{% static "bower_components/bootstrap3-dialog/dist/js/bootstrap-dialog.js" %}"></script>
<script src="{% static "bower_components/jsrender/jsrender.min.js" %}"></script>
<script src="{% static "js/tts.utils.js" %}"></script>
{% endblock morescript %}

{% block scriptcontent %}
<script id="cal-form" type="text/x-jsrender">
    {% crispy calendarform %}
</script>
<script>
window.TTS = window.TTS || {}
window.TTS.forms = window.TTS.forms || {}
TTS.forms.showcalform = function(start, end, allDay) {
    BootstrapDialog.show({
        title: 'Add Event',
        message: $($('#cal-form').render()),
        onshown: function(){
            $('#id_title').val("New Event");
            $('#id_start').val(start.format());
            $('#id_end').val(end.format());

            $('#id_start,#id_end').datetimepicker({
            });
        },
        buttons: [{
            label: 'Save',
            cssClass: 'btn-primary',
            action: function(dialogItself){
                TTS.forms.saveCal();
                dialogItself.close();
            }
            },{
            label: 'Cancel',
            action: function(dialogItself){
                dialogItself.close();
            }
        }]
    });
};

TTS.forms.saveCal = function () {
    var data = TTS.utils.serilaizeJson("#cal-event");
    $.ajax({
        headers : {
            'X-CSRFToken' : TTS.utils.getCookie('csrftoken')
        },
        type:'POST',
        data: data,
        url : '/api/admin/calendar/'
    }).done(function( msg ) {
        data = JSON.parse(data);
        TTS.forms.calendar.fullCalendar('renderEvent',
        {
            title: data.title,
            start: data.start,
            end: data.end
        },
        true // make the event "stick"
        );
    });
}

TTS.forms.updatecalform = function(calEvent, jsEvent, view) {
    console.log(calEvent)
    var start_date = calEvent.start.format().split("T");
    var start_time = start_date[1].split("+"); 
    //console.log(calEvent);
    var end_date = calEvent.end.format().split("T");
    var end_time = end_date[1].split("+");
    BootstrapDialog.show({
            title: 'Edit Event',
            message: $($('#cal-form').render()),
            onshown: function(){
                $('#id_title').val(calEvent.title);
                $('#id_start').val(start_date[0]);
                $('#id_end').val(end_date[0]);

                $('#id_start,#id_end').datetimepicker({
                });
            },
            buttons: [{
                label: 'Update',
                cssClass: 'btn-primary',
                action: function(dialogItself){
                    var data = TTS.utils.serilaizeJson("#cal-event");
                    data = JSON.parse(data);
                    $.ajax({
                        headers : {
                        'X-CSRFToken' : TTS.utils.getCookie('csrftoken')
                    },
                        type:'PUT',
                        data: JSON.stringify(data),
                        url : '/api/admin/calendar/'+calEvent.id
                    }).done(function( msg ) {
                        dialogItself.close();
                        location.reload();
                    });
                }
            },{
            label: 'Cancel',
            action: function(dialogItself){
                dialogItself.close();
            }
        }]
    });
}

TTS.forms.updatecalevent = function (event){
    var data = {
        "title" : event.title,
        "start" : event.start.format(),
        "end" : event.start.format()
    }
    $.ajax({
        headers : {
            'X-CSRFToken' : TTS.utils.getCookie('csrftoken')
        },
        type:'PUT',
        data: JSON.stringify(data),
        url : '/api/admin/calendar/'+event.id
    }).done(function( msg ) {
        location.reload();
    });
};

$(document).ready(function() {
    TTS.forms.calendar = $('#calendar').fullCalendar({
        selectable: true,
        selectHelper: true,
        resizable: true,
        droppable: true,
        editable:true,
        header:
        {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        events: {
            url:'/api/admin/calendar/'
        },
        select: function(start, end, allDay)
        {
            TTS.forms.showcalform(start, end, allDay);
        },
        eventDrop: function (event, dayDelta, minuteDelta, jsEvent, ui, view) {
            alert(event.title + " was dropped on " + event.start.format());
            if (confirm("Are you sure about this change?")) {
                TTS.forms.updatecalevent(event);
            }
        },
        eventResize: function (event, delta, revertFunc) {
            /*alert(event.title + " end is now " + event.end.format());
            if (confirm("Are you sure want this change?")) {
                TTS.forms.updatecalevent(event, delta, '');
            }else{
                revertFunc();
            }*/
            
            
            console.log("Resize");
            console.log(event);
            console.log(event.id);
            console.log(event.title);
            console.log(event.start.format());
            console.log(event.end.format());
            
        },
        eventClick: function(calEvent, jsEvent, view) {
            TTS.forms.updatecalform(calEvent, jsEvent, view);

            // change the border color just for fun
            $(this).css('border-color', 'red');
            $(this).css('background-color', '#FDFB8C');
            $(this).css('color', '#000000');

        }
        
    })
});
</script>
{% endblock scriptcontent %}

{% block morecss %}
<link rel="stylesheet" href="{%static "bower_components/fullcalendar/dist/fullcalendar.min.css" %}">
{% endblock morecss %}