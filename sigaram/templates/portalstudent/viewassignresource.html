{% extends 'portalstudent/base.html' %}
{% load staticfiles %}
{% load i18n %}
{% block topcontent %}
<div class="row">
    <div class="col-lg-12">
        <h2 class="page-header">{% trans "Deliverables" %}</h2>
    </div>
    <!-- /.col-lg-12 -->
</div>
{% endblock topcontent %}

{% block morescript %}
<script src="{% static "bower_components/bootstrap3-dialog/dist/js/bootstrap-dialog.js" %}"></script>
<script src="{% static "bower_components/jsrender/jsrender.min.js" %}"></script>
<script src="{%static "bower_components/summernote/dist/summernote.min.js" %}"></script>
<script src="{% static "js/tts.utils.js" %}"></script>
<script type="text/javascript" src="{%static "FlashWavRecorder/html/js/swfobject.js"%}"></script>
<script type="text/javascript" src="{%static "FlashWavRecorder/html/js/recorder.js"%}"></script>
<script type="text/javascript" src="{%static "FlashWavRecorder/html/basic/basic.js"%}"></script>
{% endblock morescript %}

{% block botcontent %}
<div class="col-lg-12">
    <div class="panel panel-default">
               <!-- /.panel-heading -->
        <div class="panel-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover"
                     id="admin-main-tbl">
                <div>
                    <h3>{% trans "Title" %}:</h3>
                </div><br />
                <div id="resource-title"></div><br />
                <div id="view-resource">
                     <a href="javascript:void(0)" onclick="window.open('http://10tsigaram.com/dbinterface/playfillingvideo.php?questionurl=../dbinterface/studentresources/12771A-L3-RP5(HA).swf','wdwSearch','top=100,left=100,width=1024,height=768,scrollbars=1,menu=0');">View</a>
                </div><br />
                <div>
                    <h3>{% trans "Note" %}:</h3>
                </div><br />
                <!--div class="form-group"> 
                    <label>{% trans "Answer" %} {% trans "Type" %}</label>
                    <select id="answer-type" name="answer-type">
                        <option value="text">Text</option>
                        <option value="audio">Audio</option>
                    </select>
                </div--> 
                <div class="form-group">
                    {% trans "Answer" %} {% trans "Type" %}
                </div>
                <div class="form-group">
                    <input id="show-recorder" type="radio" class="isaudio" value="audio" name="isaudio"> 
                    <label for="show-recorder">Audio</label> 
                    <input id="hide-recorder" type="radio" value="text" 
                                        name="isaudio" class="isaudio" checked="checked">
                    <label for="hide-recorder">Text</label> 
                </div> <br />
                <div id="audio-player"></div>
                <section class="recorder-container">
                    <div class="recorder">
                        <div class="level">
                            <div class="progress"></div>
                        </div>
                        <button class="start-recording" onclick="FWRecorder.record('audio', 'audio.wav');">
                            <i class="fa fa-circle fa-fw text-danger"></i>
                        </button>
                        <button class="stop-recording" onclick="FWRecorder.stopRecording('audio');">
                            <i class="fa fa-stop fa-fw"></i>
                            <!-- img src="{%static "FlashWavRecorder/html/images/stop.png" %}" alt="Stop Recording"/ -->
                        </button>
                        <button class="start-playing" onclick="FWRecorder.playBack('audio');" title="Play">
                            <i class="fa fa-play fa-fw"></i>
                            <!-- img src="{%static "FlashWavRecorder/html/images/play.png" %}" alt="Play"/ -->
                        </button>
                        <div class="upload" style="display: inline-block">
                            <div id="flashcontent">
                                <p>Your browser must have JavaScript enabled and the Adobe Flash Player installed.</p>
                            </div>
                        </div>
                    </div>
                    <form id="uploadForm" name="uploadForm" action="/api/admin/audioupload/">
                        <input id="authenticity_token" name="authenticity_token" value="xxxxx" type="hidden">
                        <input id="upload_file[parent_id]" name="upload_file[parent_id]" value="1" type="hidden">
                        <input id="uploadfilename" name="uploadfilename"  type="text">
                        <input id="format" name="format" value="json" type="hidden">
                    </form>
                    <audio controls>
                        <source src="/static/file.wav" type="audio/wav">
                        Your browser does not support the audio element.
                    </audio>
                </section>
                <div class="form-group"> 
                    <label>{% trans "Answer" %}</label>
                </div> 
                <div class="form-group">
                    <textarea class="summernote text_area"></textarea>
                </div>
                <div class="form-group">
                    <button class="btn btn-success btn-lg" id="res-save">{% trans 'Save' %}</button>
                    <button class="btn btn-success btn-lg" id="res-send">{% trans 'Send' %}</button>
                </div>                    
                </table>
            </div>
            <!-- /.table-responsive -->
        </div>
        <!-- /.panel-body -->
    </div>
    <!-- /.panel -->
</div>
<!-- /.col-lg-12 -->
{% endblock botcontent%}

{% block morecss %}
<link href="{%static "bower_components/bootstrap3-dialog/dist/css/bootstrap-dialog.css" %}" rel="stylesheet">
<link rel="stylesheet" href="{%static "bower_components/summernote/dist/summernote.css" %}">
<link type="text/css" rel="stylesheet" href="{%static "FlashWavRecorder/html/basic/basic.css"%}">
<style>
    #addrec:hover, #admin-main-tbl tbody tr:hover{
        cursor: pointer;
    }
    .note-editable{
        height: 80px;
    }

</style>
{% endblock morecss %}


{% block scriptcontent %}

<script>

window.TTS = window.TTS || {}
TTS.forms = TTS.forms || {}   


TTS.forms.renderassignedresourceinfo = function(data){
    $(".summernote").code(data.answertext);
    $("#resource-title").html(data.resourcetitle);
    $("#view-resource").html("<a href='#' onclick=\"openwindow('"+data.videourl+"');\" >View</a>");
    if(data.isrecord && data.answerurl){
        $("#audio-player").html('<audio src="'+data.answerurl+'" controls=""></audio><br />');    
    }
    
};
function openwindow(videourl) {
    window.open("http://10tsigaram.com/dbinterface/playfillingvideo.php?questionurl=../dbinterface/"+videourl, "wdwSearch" ,top=100,left=100,width=1024,height=768,scrollbars=1,menu=0)
}
TTS.forms.ressave = function(savesend){
    var data = {};
    var assignedid = getUrlParameter('assignedid');
    data.originaltext = $(".summernote").code();
    data.answertext = $(".summernote").code();
    data.answertype = $(".isaudio:checked").val();

    if($("#recorder-wrap").next().find('a')){
        data.answerurl = $("#audio_container a").prop('href');
    }else{
        data.answerurl = '';
    }

    if(data.answertype == 'audio')
        data.isrecord = 1;
    else
        data.isrecord = 0;

    if(savesend == 'save')
        data.issaved = 1;
    else
        data.issaved = 0;

    if(savesend == 'send')
        data.isanswered = 1;
    else
        data.isanswered = 0;

    data.type = 1;

    $.ajax({
        headers : {
            'X-CSRFToken' : TTS.utils.getCookie('csrftoken')
        },
        url:"/api/admin/studentassignresource/"+assignedid+"/",
        type:"PUT",
        data: data
    }).done(function(data){
        if(data.msg)
            window.location = 'assignedresourcelist';
    }).error(function(err, msg){
        alert("I didnt save the data");
    });
}
$(document).ready(function(){
    $('.summernote').summernote();
    $('#recorder-wrap').hide();
    $('#show-recorder').on("click",function(){
        $('#recorder-wrap').show();
    });
    $('#hide-recorder').on("click",function(){
        $('#recorder-wrap').hide();
    });

    var assignedid = getUrlParameter('assignedid');

    $("#res-save").click(function(){
        TTS.forms.ressave('save');
    });
    $("#res-send").click(function(){
        TTS.forms.ressave('send');
    });
    $.ajax({
        "url":"/api/admin/studentassignresource/"+assignedid+"/?format=json",
        "type":"GET"
    }).done(function(data){
        console.log(data);
        TTS.forms.renderassignedresourceinfo(data);
    });
});

function getUrlParameter(sParam)
{
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split('&');
    for (var i = 0; i < sURLVariables.length; i++) 
    {
        var sParameterName = sURLVariables[i].split('=');
        if (sParameterName[0] == sParam) 
        {
            return sParameterName[1];
        }
    }
}

function audioReceived(filename, filedata) {
        filedata = window.atob(filedata);
        var container = document.getElementById('audio_container');
        var wrap = document.getElementById('recorder-wrap');
        var link = document.createElement('a');
        var audio = document.createElement('audio');
        var WU = window.URL || window.webkitURL;
        var blob, recorderHTML;
        
        // Extract raw data from Base64-encoded string
        var ar = new Uint8Array(filedata.length);
        for(var i=0;i<filedata.length;++i) {
            ar[i] = filedata.charCodeAt(i);
        }

        // Put audio data into a blob and set up <audio> tag
        blob = new Blob([ar], {type:'audio/x-wav'});
        audio.src = WU.createObjectURL(blob);
        audio.controls = true;

        container.innerHTML = '';
        link.href = audio.src;
        link.appendChild(document.createTextNode('Download this recording'));
        link.download = filename;
        container.appendChild(audio);
        container.appendChild(document.createElement('br'));
        container.appendChild(document.createElement('br'));
        container.appendChild(link);
}

        flashvars = {gateway:'form', 'return':'reset', callback:'audioReceived', format:'wav'};
        swfobject.embedSWF("{% static "bower_components/local-audio-recorder-master/build/recorder.swf" %}", "recorder", "215", "138", "10.1", "{% static "bower_components/local-audio-recorder-master/demo/expressInstall.swf"  %}", flashvars);
</script>
{% endblock scriptcontent %}